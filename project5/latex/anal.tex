\documentclass[english,notitlepage,reprint,nofootinbib]{revtex4-1}  % defines the basic parameters of the document
% For preview: skriv i terminal: latexmk -pdf -pvc filnavn
% If you want a single-column, remove "reprint"

% Allows special characters (including æøå)
\usepackage[utf8]{inputenc}
% \usepackage[english]{babel}

%% Note that you may need to download some of these packages manually, it depends on your setup.
%% I recommend downloading TeXMaker, because it includes a large library of the most common packages.

\usepackage{physics,amssymb}  % mathematical symbols (physics imports amsmath)
\include{amsmath}
\usepackage{graphicx}         % include graphics such as plots
\usepackage{xcolor}           % set colors
\usepackage{hyperref}         % automagic cross-referencing
\usepackage{listings}         % display code
\usepackage{subfigure}        % imports a lot of cool and useful figure commands
% \usepackage{float}
%\usepackage[section]{placeins}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{subfigure}
\usepackage{tikz}
\usetikzlibrary{quantikz}
% defines the color of hyperref objects
% Blending two colors:  blue!80!black  =  80% blue and 20% black
\hypersetup{ % this is just my personal choice, feel free to change things
	colorlinks,
	linkcolor={red!50!black},
	citecolor={blue!50!black},
	urlcolor={blue!80!black}}


% ===========================================


\begin{document}
\onecolumngrid

We have:   

\begin{equation}
    i \frac{\partial u}{\partial t} = - \frac{\partial^2 u}{\partial x^2} - \frac{\partial^2 u}{\partial y^2} + v(x,y)u
\end{equation}

By using the Crank-Nicolson method we get:

\begin{equation} \label{eq:dudt}
    \frac{\partial u}{\partial t} = \frac{u_{i,j}^{n+1} - u_{i,j}^n}{\Delta t}
\end{equation} 

\begin{equation} \label{eq:x2}
    \frac{\partial^2 u}{\partial x^2} = \frac{ \left( u_{i+1, j}^{n+1} - 2u_{i, j}^{n+1} + u_{i-1, j}^{n+1} \right) + \left( u_{i+1, j}^{n} - 2u_{i, j}^{n} + u_{i-1, j}^{n} \right) }{2 \Delta x^2}
\end{equation}

\begin{equation} \label{eq:y2}
    \frac{\partial^2 u}{\partial y^2} = \frac{ \left( u_{i, j+1}^{n+1} - 2u_{i, j}^{n+1} + u_{i, j-1}^{n+1} \right) + \left( u_{i, j+1}^{n} - 2u_{i, j}^{n} + u_{i, j-1}^{n} \right) }{2 \Delta y^2}
\end{equation}

\begin{equation} \label{eq:uv}
    v(x,y)u = \frac{1}{2} \left(v_{i,j} u_{i,j}^{n+1} + v_{i,j} u_{i,j}^n\right)
\end{equation}

If we put (\ref{eq:dudt}), (\ref{eq:x2}), (\ref{eq:y2}) and (\ref{eq:uv}) together we'll get:

\begin{align} \label{eq:step1}
\begin{split}
    &i \frac{u_{i,j}^{n+1} - u_{i,j}^n}{\Delta t} = - \frac{ \left( u_{i+1, j}^{n+1} - 2u_{i, j}^{n+1} + u_{i-1, j}^{n+1} \right) + \left( u_{i+1, j}^{n} - 2u_{i, j}^{n} + u_{i-1, j}^{n} \right) }{2 \Delta x^2} \\ 
    &- \frac{ \left( u_{i, j+1}^{n+1} - 2u_{i, j}^{n+1} + u_{i, j-1}^{n+1} \right) + \left( u_{i, j+1}^{n} - 2u_{i, j}^{n} + u_{i, j-1}^{n} \right) }{2 \Delta y^2} + \frac{1}{2} \left(v_{i,j} u_{i,j}^{n+1} + v_{i,j} u_{i,j}^n\right)
\end{split}
\end{align}

Since all dimensions have been scaled away, we can replace $x$, $y$ with $h$, and we get:

Sorting, such that we get $u^n$ and $u^{n-1}$ separated:

\begin{align}
\begin{split}
    &i \frac{u_{i,j}^{n+1}}{\Delta t} + \frac{\left( u_{i+1, j}^{n+1} - 2u_{i, j}^{n+1} + u_{i-1, j}^{n+1} \right)}{2 \Delta x^2} + \frac{\left( u_{i, j+1}^{n+1} - 2u_{i, j}^{n+1} + u_{i, j-1}^{n+1} \right)}{2 \Delta y^2} = \\
    &- i \frac{u_{i,j}^{n}}{\Delta t} - \frac{\left( u_{i+1, j}^{n} - 2u_{i, j}^{n} + u_{i-1, j}^{n} \right)}{2 \Delta x^2} - \frac{\left( u_{i, j+1}^{n} - 2u_{i, j}^{n} + u_{i, j-1}^{n} \right)}{2 \Delta y^2} + \frac{1}{2} \left(v_{i,j} u_{i,j}^{n+1} + v_{i,j} u_{i,j}^n\right)
\end{split}
\end{align}

Since all dimensions have been scaled away, we can replace $x$, $y$ with $h$, and we get:

\begin{align}
\begin{split}
    &i \frac{u_{i,j}^{n+1}}{\Delta t} + \frac{\left( u_{i+1, j}^{n+1} - 2u_{i, j}^{n+1} + u_{i-1, j}^{n+1} \right)}{2 \Delta h^2} + \frac{\left( u_{i, j+1}^{n+1} - 2u_{i, j}^{n+1} + u_{i, j-1}^{n+1} \right)}{2 \Delta h^2} = \\
    &- i \frac{u_{i,j}^{n}}{\Delta t} - \frac{\left( u_{i+1, j}^{n} - 2u_{i, j}^{n} + u_{i-1, j}^{n} \right)}{2 \Delta h^2} - \frac{\left( u_{i, j+1}^{n} - 2u_{i, j}^{n} + u_{i, j-1}^{n} \right)}{2 \Delta h^2} + \frac{1}{2} v_{i,j} u_{i,j}^{n+1} + \frac{1}{2} v_{i,j} u_{i,j}^n
\end{split}
\end{align}

Multiplying each side with $i \Delta t$ such that we can use $r \equiv \frac{i \Delta t}{2h^2}$ and we get:

\begin{align}
\begin{split}
    &- u_{i,j}^{n+1} + r \left( u_{i+1, j}^{n+1} - 2u_{i, j}^{n+1} + u_{i-1, j}^{n+1} \right) + r \left( u_{i, j+1}^{n+1} - 2u_{i, j}^{n+1} + u_{i, j-1}^{n+1} \right) - \frac{i \Delta t}{2} v_{i,j} u_{i,j}^{n+1} = \\
    &- u_{i,j}^{n} - r \left( u_{i+1, j}^{n} - 2u_{i, j}^{n} + u_{i-1, j}^{n} \right) - r \left( u_{i, j+1}^{n} - 2u_{i, j}^{n} + u_{i, j-1}^{n} \right) + \frac{i \Delta t}{2} v_{i,j} u_{i,j}^n
\end{split}
\end{align}

and by switching the signs, we finally get:

\begin{align} \label{eq:crank}
\begin{split}
    &u_{ij}^{n+1}  -  r \left(u_{i+1,j}^{n+1} - 2u_{ij}^{n+1} + u_{i-1,j}^{n+1}\right)  -  r \left(u_{i,j+1}^{n+1} - 2u_{ij}^{n+1} + u_{i,j-1}^{n+1}\right)  +  \frac{i \Delta t}{2} v_{ij} u_{ij}^{n+1} \\
    &= u_{ij}^n  +  r \left(u_{i+1,j}^n - 2u_{ij}^n + u_{i-1,j}^n\right)  +  r \left(u_{i,j+1}^n - 2u_{ij}^n + u_{i,j-1}^n\right)  -  \frac{i \Delta t}{2} v_{ij} u_{ij}^n,
\end{split}    
\end{align}


\end{document}