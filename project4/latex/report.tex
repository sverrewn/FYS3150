%% USEFUL LINKS:
%% -------------
%%
%% - UiO LaTeX guides:          https://www.mn.uio.no/ifi/tjenester/it/hjelp/latex/
%% - Mathematics:               https://en.wikibooks.org/wiki/LaTeX/Mathematics
%% - Physics:                   https://ctan.uib.no/macros/latex/contrib/physics/physics.pdf
%% - Basics of Tikz:            https://en.wikibooks.org/wiki/LaTeX/PGF/Tikz
%% - All the colors!            https://en.wikibooks.org/wiki/LaTeX/Colors
%% - How to make tables:        https://en.wikibooks.org/wiki/LaTeX/Tables
%% - Code listing styles:       https://en.wikibooks.org/wiki/LaTeX/Source_Code_Listings
%% - \includegraphics           https://en.wikibooks.org/wiki/LaTeX/Importing_Graphics
%% - Learn more about figures:  https://en.wikibooks.org/wiki/LaTeX/Floats,_Figures_and_Captions
%% - Automagic bibliography:    https://en.wikibooks.org/wiki/LaTeX/Bibliography_Management  (this one is kinda difficult the first time)
%%
%%                              (This document is of class "revtex4-1", the REVTeX Guide explains how the class works)
%%   REVTeX Guide:              http://www.physics.csbsju.edu/370/papers/Journal_Style_Manuals/auguide4-1.pdf
%%
%% COMPILING THE .pdf FILE IN THE LINUX IN THE TERMINAL
%% ----------------------------------------------------
%%
%% [terminal]$ pdflatex report_example.tex
%% 
%% Run the command twice, always.
%%
%% When using references, footnotes, etc. you should run the following chain of commands:
%%
%% [terminal]$ pdflatex report_example.tex
%% [terminal]$ bibtex report_example
%% [terminal]$ pdflatex report_example.tex
%% [terminal]$ pdflatex report_example.tex
%%
%% This series of commands can of course be gathered into a single-line command:
%% [terminal]$ pdflatex report_example.tex && bibtex report_example.aux && pdflatex report_example.tex && pdflatex report_example .tex
%%
%% ----------------------------------------------------


\documentclass[english,notitlepage,reprint,nofootinbib]{revtex4-1}  % defines the basic parameters of the document
% For preview: skriv i terminal: latexmk -pdf -pvc filnavn
% If you want a single-column, remove "reprint" 

% Allows special characters (including æøå)
\usepackage[utf8]{inputenc}
% \usepackage[english]{babel}

%% Note that you may need to download some of these packages manually, it depends on your setup.
%% I recommend downloading TeXMaker, because it includes a large library of the most common packages.

\usepackage{physics,amssymb}  % mathematical symbols (physics imports amsmath)
\include{amsmath}
\usepackage{graphicx}         % include graphics such as plots
\usepackage{xcolor}           % set colors
\usepackage{hyperref}         % automagic cross-referencing
\usepackage{listings}         % display code
\usepackage{subfigure}        % imports a lot of cool and useful figure commands
% \usepackage{float}
%\usepackage[section]{placeins}
\usepackage{algorithm}
\usepackage[noend]{algpseudocode}
\usepackage{subfigure}
\usepackage{tikz}
\usetikzlibrary{quantikz}
% defines the color of hyperref objects
% Blending two colors:  blue!80!black  =  80% blue and 20% black
\hypersetup{ % this is just my personal choice, feel free to change things
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}}


% ===========================================


\begin{document}

\title{Numerical Simulation of Phase Transitions In Ferromagnets Using the 2D Ising Model}  % self-explanatory
\author{Sverre Wehn Noremsaune, Jon Aleksander Prøitz, Marius Torsvoll, Frida Marie Engøy Westby} % self-explanatory
\date{\today}                             % self-explanatory
\noaffiliation                            % ignore this, but keep it.

%This is how we create an abstract section.
\begin{abstract}
   This paper will investigate a phase transition in a ferromagnet, using a Marko-Chain Monte Carlo simulation of the 2D ising model. We will be approximating the infinite lattice using periodic boudnary conditions on a fairly small lattice. 
   First we verify the numerical results of a 2x2 lattice. Then we see that for higher temperatures, the system becomes more unstable and likely to flip spins. Then we approximate the phase transition where the ferroamgnet loses all magnetic properties to about $T=2.2699$.
\end{abstract}
\maketitle


% ===========================================
\section{Introduction}
%
In this paper the analytical and numerical models shall be developed. The advantages of the numerical model shall be made apparent with
the simulation of larger systems than analytically practical. The analytical development of the Ising model was originally done for the 
one dimensional case with no phase transitions. As will be proven quite clearly by the 2 dimensional case there actually exists a phase 
transition for the ferro-magnetic case. 
\\
\\
The analytical model is developed for a small 2x2 lattice and used to verify the validity of the numerical model. This is physically 
relevant to make sure the model is on the right track. A deviation in the more trivial cases would naturally be undesirable. The model 
aims to predict the critical temperature of the ferro magnetic case. 
\\
\\
The Ising model is a model based on statistical mechanics of the spin states of a ferro-magnet. The model takes into account the energy state of same spin and alternate spin neighbours and allows these neighbouring particles to interact with each other. The 2 dimensional case allows for the modelling of a magnetic phase transition. Giving us the prediction of a critical temperature, collapse of the magnetic case and thus a phase transition. 
\\
\\
The Ising model originally did not predict a phase transition, but the original model was only of one dimension. Thus the 2 dimensional case being relevant as this allows us to make this prediction. Thus the utility of the 2 dimensional lattice case becomes rather obvious. 
\\
\\
The model is constructed and simulated in the c++ language and the results is plotted in python. This allows us to simulate the situation rather efficiently. This need for computational speed becomes rather apparent when one considers the need for the 2 dimensional case and the increased need for FLOPs. 
% ===========================================
\section{Methods}\label{sec:methods}

For the Ising model we have studied the 2D square lattices of spins $s_i$. The spin configuration can be up (+1) or down (-1) (as seen in TABLE \ref{tab:possible_states}).

The model uses a lattice with periodic boundary conditions, which have length $L$ and $N$ spins. This gives us

\begin{equation}
    N = L^2
\end{equation}

For our system, the total energy is given by when we sums over all neighbouring (up, down, left, right) pairs of spins ($\langle k,l\rangle $), without double-counting

\begin{equation} \label{eq:tot_energy}
    \mathbf{E(\mathbf{s}) = -J\sum\limits_{\langle k,l\rangle}^Ns_ks_l}
\end{equation}

where $\mathbf{J}$ are the $\mathit{coupling constant}$ and $\mathbf{s}$ represents the spin state of the entire system \textit{microstate} or \textit{spin configuration} and is given by 

\begin{equation}
    \mathbf{s} = \left( s_1, s_2, ... , s_N \right).
\end{equation}

If we sum over all the spin in the system we'll get the total magnetization:

\begin{equation}
    \mathbf{M} (\mathbf{s}) = \sum\limits_i^N s_i.
\end{equation}

To compare the results we get for different lattice sizes, we use magnetization per spin ($m$): 

\begin{equation}
    m (\mathbf{s}) = \frac{M(\mathbf{s})}{N},
\end{equation}

and energy per spin ($\epsilon$):

\begin{equation}
    \epsilon (\mathbf{s}) = \frac{\mathbf{E}(\mathbf{s})}{N}
\end{equation}

We use \textit{Boltzmann distribution} to get the probability for the system state, given a system temperature ($T$):

\begin{equation}
    p(\mathbf{s} ; T) = \frac{1}{Z} e^{- \beta \mathbf{E}(\mathbf{s})},
\end{equation}

where $Z$ is the \textit{partition function} which ia a normalization constant. $\beta$ represents the inverse temperature:

\begin{equation}
    \beta = \frac{1}{k_B T},
\end{equation}
here $k_B$ are called the \textit{Boltzmann constant}.

We also have the partition function ($Z$) summing over all possible $\textbf{s}$ (i):

\begin{equation}
    Z = \sum\limits_{i} e^{- \beta \mathbf{E}(\mathbf{s})},
\end{equation}

which can be expressed analytical as:

\begin{align*}
    Z %&= \sum\limits_{i} e^{- \beta \mathbf{E}(\mathbf{s})} \\
    &= e^{8 \beta J} + 4 + 2 e^{-8 \beta J} + 4 + 4 + e^{-8 \beta J} \\
    &= 2e^{8 \beta J} + 2e^{-8 \beta J} + 12 \\
    &= 4 \cosh (8 \beta J) + 12
\end{align*}

We notice that $\langle E\rangle = \sum\limits_{s}$

\begin{align*}
    \langle E\rangle &= \sum\limits_{s} E(s) p(s;1)\\
    &= \sum\limits_{s} \frac{E(s)}{Z} e^{- \beta E(s)} \\
    &= - \frac{1}{Z} \sum\limits_{s} \frac{\partial}{\partial \beta} e^{- \beta E(s)} \\
    &= - \frac{1}{Z} \frac{\partial}{\partial \beta} \sum\limits_{s} e^{- \beta E(s)} \\
    &= - \frac{1}{Z} \frac{\partial}{\partial \beta} Z \\
    &= -8 \frac{J \sinh (8 \beta J)}{\cosh (8 \beta J) + 3}
\end{align*}

Hence

\begin{equation}
    \langle \epsilon\rangle = \langle \frac{E}{N}\rangle = -2 \frac{J \sinh (8 \beta J)}{\cosh (8 \beta J) + 3}
\end{equation}

which gives us

\begin{equation}
    \langle \epsilon^2\rangle  = \frac{1}{N^2 Z} \frac{\partial^2}{\partial \beta^2} Z = 4 J^2 \frac{J \sinh (8 \beta J)}{\cosh (8 \beta J) + 3}
\end{equation}

For $\langle|m|\rangle$ we get

\begin{align*}
    \langle|m|\rangle  = \frac{\langle|M|\rangle}{N} &= \frac{1}{N Z} \sum\limits_{s} |M(s)| e^{- \beta E(s)} \\
    &= \frac{1}{4 Z} \left( 4 e^{8 \beta J} + 8 + 8 + 4 e^{8 \beta J} \right) \\
    &= \frac{2 e^{8 \beta J}  + 4}{4 \cosh (8 \beta J) + 12} \\
    &= \frac{e^{8 \beta J}  + 2}{2 \cosh (8 \beta J) + 6}
\end{align*}

and 

\begin{align*}
    \langle m^2\rangle = \frac{\langle M^2\rangle}{N^2} &= \frac{1}{N^2 Z} \sum\limits_{s} M(s)^2 e^{-8 \beta E(s)} \\
    &= \frac{1}{16 Z} \left( 16 e^{8 \beta J} + 16 + 16 + 16 e^{8 \beta J} \right) \\
    &= \frac{e^{8 \beta J}  + 1}{2 \cosh (8 \beta J) + 6}
\end{align*}

We get the specific heat capacity, normalized to number of spins, by:

\begin{equation}
	C_V = \frac{1}{N}\frac{1}{k_bT^2}\left(\langle E^2\rangle - \langle E\rangle^2\right)
\end{equation}

And likewise the susceptebility normalized to the number of spins is given by

\begin{equation}
	\chi = \frac{1}{N}\frac{1}{k_bT}\left(\langle M^2\rangle - \langle |M|\rangle^2\right)
\end{equation}


To find the difference in energy when a single spin flips, we first write the total energy of the system as

\begin{equation}
    E_{\mathbf{s}} = E_{\text{ext}} + \left( -J \sum\limits_{j = 1}^4 s_i s_j \right)
\end{equation}
where $E_{ext}$ is the energy from all spin combinations not affilited with spin that flips, and the second term is the energy affilited with the flipping spin.
The difference in energy can therefore be written

\begin{align*}
    \Delta E &= E_{\text{after}} - E_{\text{before}} \\
    &= E_{\text{ext}} - J \sum\limits_{j = 1}^4 s_{\text{after}} s_j - E_{\text{ext}} + J \sum\limits_{j = 1}^4 s_{\text{before}} s_j \\
    &= J \left( \left( -s_ \text{after} + s_{\text{before}} \right) 2 \sum\limits_{j = 1}^4 s_j \right)
\end{align*}

such that with $s_{\text{after}} = - s_{\text{before}}$, we get:

\begin{equation}
    \Delta E = 2J s_{\text{before}} \sum\limits_{j = 1}^4 s_j
\end{equation}

To approximate the temperature, we'll use the scaling relation
\begin{equation}
	T_c(L) - T_c(L=\infty) = aL^{-1}
\end{equation}
Which we can rewrite to
\begin{equation}
	T_c(L=\infty) = T_c(L) - \frac{a}{L}
	\label{eq:scaling}
\end{equation}

% ===========================================
\subsection*{Algorithms}

\begin{figure}
	% NOTE: We only need \begin{figure} ... \end{figure} here because of a compatability issue between the 'revtex4-1' document class and the 'algorithm' environment.
	\begin{algorithm}[H]
		\caption{Metropolis Algorithm}
		\label{algo:metropolis}
		\begin{algorithmic}
			\Procedure{Metropolis}{$x, x', p(x'), i$}
			\State Generate new state proposal $x'$ from $x$
			\State Calculate probability of new state $p(x')$
			\State Generate random number  $i \in [0,1]$
			\State Accept if $i \leq p(x')$, reject if not
			\EndProcedure
		\end{algorithmic}
	\end{algorithm}
\end{figure}

The Metropolis-algorithm\cite{metropolis}\cite{compy_phys_lecture_notes} is given in \ref{algo:metropolis}\cite. It is an algorithm for generating a Markov Chain Monte Carlo chain to simulate drawing numbers from a probability distribution.
% ===========================================
\section{Results and Discussion}\label{sec:results}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/testE.pdf} %Imports the figure.
	\caption{The expectation value of $\epsilon$ for $\log_{10} x$ Monte Carlo cycles compared to the analytical solution for $L=2$ and $T=1$.}
	\label{fig:testE}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/testM.pdf} %Imports the figure.
	\caption{The expectation value of $|m|$ for $\log_{10} x$ Monte Carlo cycles compared to the analytical solution for $L=2$ and $T=1$.}
	\label{fig:testM}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/testCv.pdf} %Imports the figure.
	\caption{The value of $C_v$ for $\log_{10} x$ Monte Carlo cycles compared to the analytical solution for $L=2$ and $T=1$.}
	\label{fig:testCv}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/testX.pdf} %Imports the figure.
	\caption{The value of $\chi$ for $\log_{10} x$ Monte Carlo cycles compared to the analytical solution for $L=2$ and $T=1$.}
	\label{fig:testX}
\end{figure}

As we can see in \ref{fig:testE} \ref{fig:testM} \ref{fig:testCv} \ref{fig:testX} we need about $10^5$ Monte Carlo cycles to get a good agreement between the numerical and analytical solution. $\chi$ disagrees somewhat, but this could be due to numerical errors, but as should be noted, both the system numerically and analytically are very stable, as expected.
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/burn_inE.pdf} %Imports the figure.
	\caption{The expectation value of $\epsilon$ for $\log_{10} x$ Monte Carlo cycles for $T=1$ and $T=2.4$ with $L=20$.}
	\label{fig:burn_inE}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/burn_in|m|.pdf} %Imports the figure.
	\caption{The expectation value of $|m|$ for $\log_{10} x$ Monte Carlo cycles for $T=1$ and $T=2.4$ with $L=20$.}
	\label{fig:burn_in|m|}
\end{figure}

With a significantly larger lattice size of $L=20$ we can see, as shown in \ref{fig:burn_inE} and \ref{fig:burn_in|m|}, we can see that burn in time is about $10^5$ cycles. As the system might have started in an improbable state, or wandered off in an improbable direction, discarding these first samples would allow you to start from a more probable place.

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/hist_T1.pdf} %Imports the figure.
	\caption{Histogram of $10^6$ $\epsilon$ samples for $L=20$ and $T=1.0$}
	\label{fig:hist_T1}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/hist_T2.pdf} %Imports the figure.
	\caption{Histogram of $10^6$ $\epsilon$ samples for $L=20$ and $T=2.4$}
	\label{fig:hist_T2}
\end{figure}

When we take a look at what specific values $\epsilon$ takes when we simulate for $10^6$ cycles, \ref{fig:hist_T1} \ref{fig:hist_T2}, we see that the system for $T=1$ is incredibly likely to remain stable, with extremely few values of $\epsilon$ not being $-2$. For $T=2.4$ however, a lot more spins are flipping and we can see that the system has the potential to lose most of its magnetic properties.
\newline
To compute the final part we parallelise the code, and see on average a $10$ times speed-up when using $16$ threads over a single thread.
\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/<e>_differing_L.pdf} %Imports the figure.
	\caption{plot of $\langle\epsilon\rangle$ in the range $T \in [2.1,2.4]$ for $L=40,60,80,100$, each run consisiting of $2*10^5$ Monte Carlo cycles}
	\label{fig:e_differing}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/<|m|>_differing_L.pdf} %Imports the figure.
	\caption{plot of $\langle|m|\rangle$ in the range $T \in [2.1,2.4]$ for $L=40,60,80,100$, each run consisiting of $2*10^5$ Monte Carlo cycles}
	\label{fig:m_differing}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/Cv_differing_L.pdf} %Imports the figure.
	\caption{plot of $C_v$ in the range $T \in [2.1,2.4]$ for $L=40,60,80,100$, each run consisiting of $2*10^5$ Monte Carlo cycles}
	\label{fig:Cv_diff_l}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[scale=0.5]{../figs/X_differing_L.pdf} %Imports the figure.
	\caption{plot of $\chi$ in the range $T \in [2.1,2.4]$ for $L=40,60,80,100$, each run consisiting of $2*10^5$ Monte Carlo cycles}
	\label{fig:X_diff_l}
\end{figure}

Finally we look at the results from simulating the system very closely for $T \in[2.1,2.4]$ in \ref{fig:e_differing} \ref{fig:m_differing} \ref{fig:Cv_diff_l} \ref{fig:X_diff_l}. For $L=40$ the expectation value of $|m|$ doesn't quite hit zero, and though the slope is pretty sedate, $C_v$ and $\chi$ follows the pattern that the larger Ls have, but not nearly to the same extent. For $L=60$ we get an expectation value of $|m|$ a lot closer to $0$ than with $l=40$, but it's by no means perfect. $C_v$ and $\chi$ show larger spikes, but the slope of $\langle|m|\rangle$ is still pretty even, though steeper than for $L=40$. $L=80$ and $L=100$ are fairly similar, though for the case of $L=100$ you have a very steep, though not infinitely steep slope in the area where $C_v$ and $\chi$ peaks, at about $2.280$. $\langle|m|\rangle$ still doesn't hit 0, but every other factor indicates that this would be approximately where the phase transition happens\cite{compy_phys_lecture_notes}. An L a few orders of magnitudes larger, like $L=10000$, might give more accurate results, as we are approximating an infinite lattice with $L=100$ at most, but this would be hideously expensive computation wise.

When applying the results to the scaling relation\ref{eq:scaling} we find that $a\approx 0.4688$. This gives us the approximations seen in table \ref{tab:T_c}. These results average out to $2.2699$.

\begin{table}
	\centering
	\begin{tabular}{cc}
			\textbf{L} & \textbf{T} \\ \hline
			40 & 2.2633 \\
			60 & 2.2722 \\
			80 & 2.2791 \\
			100 & 2.2653
		\end{tabular}%
	\caption{Approximate of $T_c(L=\infty$)}
	\label{tab:T_c}
\end{table}
% ===========================================


 
% ===========================================
\section{Conclusion}\label{sec:conclusion}
We have simulated a phase transition in a ferromagnet using Markov Chain Monte Carlo to simulate the random behaviour of spins. First we validated the correctness of the implementation by comparing the numerical result with the analytical solution for $L=2$ and found that about $10^5$ Monte Carlo cycles gave answers that were in agreement. Then we looked at the simulation for the two endpoints of the temperature region we were investigating, $T\in [1.0, 2.4]$ and saw that $|\langle\epsilon\rangle|$ was a lot lower for higher temperature, indicating spins flipping. We expanded on this by making a histogram of $10^6$ $\epsilon$ values. For $T=1$ we saw that spins flipping was incredibly rare, but that for $T=2.4$ spins flipping was a lot more likely. Lastly we zoomed in on the area $T \in[2.1,2.3]$ with bigger lattices. For $L=40,60,80,100$ we saw with increasing clarity that something happened at around $T=2.275$, which was further confirmed when the average of the approximations we for $T_c$ at $T_c \approx 2.2699$, though $<|m|>$ didn't hit $0$ here as it should for a proper phase transition, we are simulating an infinite lattice with merely $10^4$ spins, so redoing the experiment with a significantly larger lattice would probably yield better results.
\onecolumngrid

%\bibliographystyle{apalike}
\bibliography{ref}

\newpage

\appendix

\section{GitHub repository}

\centering
\url{https://github.com/sverrewn/FYS3150/tree/project4/project4} 

\section{Possible states} \label{eq_motion}

\begin{table}[H]
    \centering
    \begin{tabular}{|c|c|l|c|c|}
    \hline
        \multicolumn{1}{|l|}{\textbf{Spins in +1}} & \textbf{Sprin configuration} & $\mathbf{- J E(\vec{s}) = \sum\limits_{\langle k,l\rangle}^Ns_ks_l}$ & \multicolumn{1}{l|}{$\mathbf{M(\vec{s}) = \sum\limits_i^Ns_i}$} & \multicolumn{1}{l|}{\textbf{Degeneracy}} \\ \hline
        4 & 
        
        \begin{tabular}{ll}
            $\uparrow$ & $\uparrow$ \\ 
            $\uparrow$ & $\uparrow$ \\
        \end{tabular}
        
        & $-J(2+2+2+2) = -8J$ & 4 & 1 \\ \hline
        3 & 
        
        \begin{tabular}{ll}
            $\uparrow$ & $\downarrow$ \\ 
            $\uparrow$ & $\uparrow$ \\
        \end{tabular} 
        
        & $-J(0 -2 + 2 + 0) = 0$ & 2 & 4 \\ \hline
        2 & 
        
        \begin{tabular}{ll}
            $\downarrow$ & $\downarrow$ \\ 
            $\uparrow$ & $\uparrow$ \\
        \end{tabular}
        
        & $-J(0 + 0 + 0 + 0) = 0$ & 0 & 4 \\ \hline
        2 & 
        
        \begin{tabular}{ll}
            $\uparrow$ & $\downarrow$ \\ 
            $\downarrow$ & $\uparrow$ \\
        \end{tabular} 
        
        & $-J(-2-2-2-2)= 8J$ & 0 & 2 \\ \hline
        1 & 
        
        \begin{tabular}{ll}
            $\uparrow$ & $\downarrow$ \\ 
            $\downarrow$ & $\downarrow$ \\
        \end{tabular}
        
        & $-J(-2+0 + 0 + 2) = 0$ & -2 & 4 \\ \hline
        0 & 
        
        \begin{tabular}{ll}
            $\downarrow$ & $\downarrow$ \\ 
            $\downarrow$ & $\downarrow$ \\
        \end{tabular}
        
        & $-J(2+2+2+2) = -8J$ & -4 & 1 \\ \hline
    \end{tabular}
    \caption{All possible states of a  $2 \times 2$ lattice with periodic boundary conditions.}
    \label{tab:possible_states}
\end{table}

\end{document}